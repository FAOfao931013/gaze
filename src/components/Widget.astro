---
/**
 * Universal Widget Container
 * Provides a consistent wrapper for all widget types with header and error handling
 */

import { getWidget } from '../lib/registry'
import type { WidgetProps } from '../types/widget'
import { WidgetError } from './WidgetError'

interface Props extends WidgetProps {}

const { config, data } = Astro.props

// Check if data is an error
const isError = data && typeof data === 'object' && 'error' in data
const errorMessage = isError && 'message' in data ? String(data.message) : 'Failed to fetch data'

// Get widget definition from registry
const widgetDef = getWidget(config.type)
const WidgetComponent = widgetDef?.component

// Display title or fallback to type
const displayTitle = config.title || config.type
---

<div class="widget-wrapper" data-widget-type={config.type} data-widget-slug={config.slug}>
  {/* Widget Header - Outside the card */}
  {!config.hideHeader && (
    <div class="widget-header px-1 pb-1.5">
      <h2 class="text-xs font-semibold text-white/50 uppercase tracking-wider">{displayTitle}</h2>
    </div>
  )}

  {/* Widget Content - Inside the card */}
  <div class="widget-content glass rounded-lg overflow-hidden p-3">
    {isError ? (
      <WidgetError widgetType={config.type} error={errorMessage} client:load />
    ) : !WidgetComponent ? (
      <div class="text-white/50">
        <p class="text-sm">Unknown widget type: {config.type}</p>
        <p class="text-xs mt-2">Widget not registered in the registry</p>
      </div>
    ) : (
      <WidgetComponent config={config} data={data} />
    )}
  </div>
</div>

<style>
  .widget-wrapper {
    height: fit-content;
  }
</style>
