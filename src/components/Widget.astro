---
/**
 * Universal Widget Container
 * Provides a consistent wrapper for all widget types with header and error handling
 * Uses WidgetFrame for the visual frame (unless widget is frameless)
 */

import { getWidget } from '../lib/registry'
import type { WidgetProps } from '../types/widget'
import { WidgetError } from './WidgetError'
import WidgetFrame from './WidgetFrame.astro'

interface Props extends WidgetProps {}

const { config, data } = Astro.props

// Check if data is an error
const isError = data && typeof data === 'object' && 'error' in data
const errorMessage = isError && 'message' in data ? String(data.message) : 'Failed to fetch data'

// Get widget definition from registry
const widgetDef = getWidget(config.type)
const WidgetComponent = widgetDef?.component
const isFrameless = widgetDef?.frameless === true

// Display title or fallback to type
const displayTitle = config.title || config.type
---

{isFrameless ? (
  /* Frameless widgets (containers) render directly without frame */
  isError ? (
    <WidgetError widgetType={config.type} error={errorMessage} client:load />
  ) : !WidgetComponent ? (
    <div class="text-white/50">
      <p class="text-sm">Unknown widget type: {config.type}</p>
      <p class="text-xs mt-2">Widget not registered in the registry</p>
    </div>
  ) : (
    <WidgetComponent config={config} data={data} />
  )
) : (
  /* Normal widgets get the standard frame */
  <WidgetFrame
    title={displayTitle}
    hideHeader={config.hideHeader}
    widgetType={config.type}
    widgetSlug={config.slug}
  >
    {isError ? (
      <WidgetError widgetType={config.type} error={errorMessage} client:load />
    ) : !WidgetComponent ? (
      <div class="text-white/50">
        <p class="text-sm">Unknown widget type: {config.type}</p>
        <p class="text-xs mt-2">Widget not registered in the registry</p>
      </div>
    ) : (
      <WidgetComponent config={config} data={data} />
    )}
  </WidgetFrame>
)}
